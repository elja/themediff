REPLACE
<div class="line-items-reflective-view">
WITH
{% form 'populate_product' %}
  <div class="line-items-reflective-view">
END

REPLACE_IGNORE
{% assign line_item = line_items.first %}
WITH
END

REPLACE
{% form 'populate_product', context_name: 'f' %}
{% include 'line_item_hidden_fields' %}
WITH
END

REPLACE
{% unless product.has_multiple_quantity_option#{s?}? %}
  {% include #{['"]}stock_message#{['"]}#{.+} %}

  <table class="product-quantity">
    <tfoot>
    <tr>
      <th colspan='2'>Quantity</th>
      <td id="quantity">
        <input type="text" data-id data-type="quantity" class="amount" value="{{ line_item.quantity }}">
      </td>
    </tr>
    </tfoot>
  </table>
{% endunless %}
OR
{% if line_items.size == 1 %}
    {% unless product.has_multiple_quantity_option#{s?}? %}
        {% include #{['"]}stock_message#{['"]}#{.+} %}
    {% endunless %}

    <table class="product-quantity">
        <tfoot>
        <tr>
            <th colspan='2'>Quantity</th>
            <td id="quantity">
                <input type="text" data-id="0" data-type="quantity" class="amount"
                       value="{{ line_items[0].quantity }}">
            </td>
        </tr>
        </tfoot>
    </table>
{% endif %}
WITH
{% if product.product_options_enabled? == false or product.options_or_groups.multiple_quantity == empty %}
  <span class="stock" id="stock"></span>
  <table class="product-quantity">
      <tfoot>
      <tr>
          <th colspan='2'>Quantity</th>
          <td id="quantity">
              <input type="text" data-type="quantity" class="amount"
                     name="product[quantity]" value="{{ form.quantity | default: 0 }}"/>
          </td>
      </tr>
      </tfoot>
  </table>
{% endif %}
END

REPLACE
{% include 'product_summary', product: product, line_items: line_items %}
WITH
{% include 'product_summary' %}
END

ENSURE_NO
#{\s}line_item#{s?}
END
