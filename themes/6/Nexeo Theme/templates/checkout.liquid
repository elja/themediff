{% capture checkout_page_content %}
<div class="checkout-main">
{% form 'checkout', context_name: 'f', for: 'order' %}
{% if order.has_custom_data_collections? %}
<div class="content-item custom-data-collection">
    <h2>
        {{ cart_options.custom_data_collections_name }}
    </h2>

    {% if order.state != 'custom_data_collection' %}
    <div class="edit-checkout-container btn_2">
        <!-- <a href="/checkout/custom_data_collection" class="edit-custom-data-collection"><i class="fa fa-pencil-square-o"></i> edit {{ cart_options.custom_data_collections_name | downcase }}</a> -->
        <a href="/checkout/custom_data_collection" class="edit-custom-data-collection"><i class="fa fa-pencil-square-o"></i> edit</a>
    </div>
    {% endif %}

    <div class="checkout-cols clrfix">
        {% if order.state == 'custom_data_collection' %}

        {% for form in order.custom_data_collections %}
        <div class='custom-data-collection'>
            {% render_custom_data_collection_form form %}
            <h4>{{ form.title }} {% if form.amount != 0 %} ({{ form.amount | points_or_currency }}) {% endif %}</h4>
            {{ form.hidden_fields }}
            <div class='form-item'>
                {% for input in form.inputs %}
                {{ input.hidden_fields }}
                <label for='{{ input.label_for }}'>{{ input.label }}{% if input.required? %} *{% endif %}</label>
                {% render_custom_data_collection_input input %}
                {% endfor %}
            </div>
            {% endrender_custom_data_collection_form %}
        </div>
        {% endfor %}


		<div style="clear: left">
			<input type="submit" value="Continue" class="btn button green-button"/>
		</div>
        {% else %}
        {% include 'custom_data_attributes' order: order %}
        {% endif %}
    </div>
    </div>
{% endif %}

<div class="content-item shipping">
    <h2>
        Shipping
    </h2>
    {%if order.state != 'custom_data_collection' %}
    {% if order.state != 'address' %}
    <div class="edit-checkout-container btn_2">
        {% if order.state == 'delivery' or order.state == 'payment' or order.state == 'confirm'  %}
        <a href="/checkout/address" class="edit-shipping"><i class="fa fa-pencil-square-o"></i> edit</a>
        {% endif %}
    </div>
    {% endif %}
    <div class="checkout-cols clrfix">
        <div class="contact">
            <h4>
                Shipping contact
            </h4>
            {% if order.state == 'address' %}
            {% form_block 'f.fields_for', context_name: 'ff', object_name: 'shipping_contact' %}
            {% include 'contact_fields' %}
            {% endform_block %}
            {% else %}
            {% include 'contact_preview', contact: order.shipping_contact %}
            {% endif %}
        </div>
        <div class="address">
            <h4>
                Shipping address
            </h4>
            {% if order.state == 'address' %}
            {% include 'shipping_addresses_drop_down' %}

            {% form_block 'f.association', context_name: 'ff', object_name: 'shipping_address' %}
            {% include 'address_fields' %}
            {% endform_block %}
            {% else %}
            {% include 'address_preview', address: order.shipping_address %}
            {% endif %}

            {% if order.state == 'address' %}
            {% if current_user %}
            <label class="form-checkbox"><input type="checkbox" name="website_order[save_to_shipping_address]" {% if order.save_to_shipping_address %}checked{% endif %}/>save my address information</label>
            {% endif %}
            <input type="submit" value="Next Step" class="btn custom_btn custom-button check_btn btn-white"/>
            {% endif %}
        </div>       
    </div>
    {% endif %}
</div>

<div class="content-item shipping">
    <h2>
        Shipping Method
    </h2>
    {% if order.state != 'address' and order.state != 'custom_data_collection' %}
    {% if order.state != 'address' %}
    <div class="edit-checkout-container btn_2">        
        {% if order.state == 'payment' or order.state == 'confirm' %}
        <a href="/checkout/delivery" class="edit-shipping"><i class="fa fa-pencil-square-o"></i>edit </a>
        {% endif %}
    </div>
    {% endif %}
    <div class="checkout-cols clrfix"> 
        <div class="method {% if order.state == 'delivery' %}ready-to-select{%endif%}">
            <h4>
                Shipping method
            </h4>
            {% if order.state == 'delivery' %}
            <div class="form-radio">
                {% for shipment in shipments %}
					{% if order.state == 'delivery' %}
					   <label class="{% unless shipment.available %}unavailable{% endunless %}"><input type="radio" name="shipping_method" value="{{ shipment.shipment_id }}"/>{{ shipment.name | truncate: 40 }} ({{ shipment.price | points_or_currency }}) </label>
					{% else %}
					   <label class="unavailable"><input type="radio" name="shipping_method" value="{{ shipment.shipment_id }}"/>{{ shipment.name }} </label>
					{% endif %}
                {% endfor %}
                {% for err in shipment_errors %}
                    <p class="shipment-error">{{ err }}</p>
                {% endfor %}
            </div>

            {% elsif order.state == 'custom_data_collection' or order.state == 'payment' or order.state == 'confirm' %}
            <div>
                <p class="truncated">
                    {{ order.shipment.shipment_friendly_name }}
                </p>
            </div>
            {% endif %}

            {% if order.state == 'delivery' %}
            <input type="submit" value="Continue" class="btn button green-button"/>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<div class="content-item payment">
    <h2>
        Payment
    </h2>
    {%if order.billing_address and order.billing_address.first_address.length != 0 and order.billing_contact and order.billing_contact.name.length != 0 %}

    {% if order.state == 'confirm' %}
    <div class="edit-checkout-container btn_2">
        <a href="/checkout/payment" class="edit-payment"><i class="fa fa-pencil-square-o"></i> edit</a>
    </div>
    {% endif %}
    <div class="checkout-cols clrfix">
        {% if order.billing_contact and order.billing_contact.name.length != 0 %}
        <div class="contact">
            <h4>
                Billing contact
            </h4>
            {% if order.state == 'payment' %}
            <label class="form-checkbox">
                {% form_field 'f.check_box', 'use_same_as_shipping_contact', { "id": "same-as-shipping-contact" } %}
                <label for="same-as-shipping-contact">same as shipping contact</label>
            </label>
            {% form_block 'f.fields_for', context_name: 'ff', object_name: 'billing_contact' %}
            {% include 'contact_fields' %}
            {% endform_block %}
            {% elsif order.billing_contact %}
            {% include 'contact_preview', contact: order.billing_contact %}
            {% endif %}
        </div>
        {% endif %}
        {% if order.billing_address and order.billing_address.first_address.length != 0 %}
        <div class="address">
            <h4>
                Billing address
            </h4>
            {% if order.state == 'payment' %}
            <label class="form-checkbox">
                {% form_field 'f.check_box', 'use_same_as_shipping_address', { "id": "same-as-shipping-address" } %}
                <label for="same-as-shipping-address">same as shipping address</label>
            </label>
            {% include 'billing_addresses_drop_down' %}

            {% form_block 'f.fields_for', context_name: 'ff', object_name: 'billing_address' %}
            {% include 'address_fields' %}
            {% endform_block %}

            {% if current_user %}
            <label class="form-checkbox"><input type="checkbox" name="website_order[save_to_billing_address]" {% if order.save_to_billing_address %}checked{% endif %}/>save my address information</label>
            {% endif %}
            {% elsif order.billing_address %}
            {% include 'address_preview', address: order.billing_address %}
            {% endif %}
        </div>
        {% endif %}
        <div class="method">
            {% if order.state == 'payment' %}
            <h4>
                Billing method
            </h4>
            <div class="form-radio">
                {% for payment_method in shop.available_payment_methods %}
                    {% render_payment_method_checkbox payment_method %}
                {% endfor %}
            </div>

            {% for payment_method in shop.available_payment_methods %}
                {% render_payment_method_template payment_method %}
            {% endfor %}

            <div class="form-item promotions">
                {% form_field 'f.label', 'coupon_code' %}
                {% form_field 'f.text_field', 'coupon_code', { "class": "input-text promo-code clearHint", "placeholder": "promotional code" } %}
                {% form_field 'f.submit', 'Apply', { "name": "apply_coupon_code", "class": "btn-apply button" } %}
                {% form_field 'f.submit', '', { "id": "update_coupon_code", "name": "update_coupon_code", "style": "display: none;" } %}
                {% form_block 'f.fields_for', context_name: 'ff', object_name: 'promotion_adjustments' %}
                {% form_field 'ff.link_to_remove', '', { "class": "remove-promotion" } %}
                <span title="{{ ff.object.note }}" class="coupon-note">{{ ff.object.note }}</span>
                ({{ ff.object.amount | points_or_currency }})
                {% endform_block %}
            </div>
            {% if current_user %}
            <div class="form-item">
                {% form_field 'f.label', 'gift_certificate' %}
                {% form_field 'f.text_field', 'gift_certificate', { "class": "input-text gift-certificate clearHint", "placeholder": "gift certificate" } %}
                {% form_field 'f.submit', 'Apply', { "name": "apply_gift_certificate", "class": "btn-apply button" } %}
            </div>
            <p class="balance-info">
                You have
                <span style="color: red;">{{ current_user.balance | points_or_currency }}</span>
                in your balance
            </p>
            <label class="form-checkbox" for='website_order_use_balance'>{% form_field 'f.check_box', 'use_balance' %}use my account balance</label>
            {% endif %}
            <input type="submit" value="Continue" class="btn button green-button"/>
            {% elsif order.payment %}
            <h4>
                Billing method
            </h4>
            {% render_payment_template order.payment %}
            {% render_adjustments_template %}
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>
{% endform %}
</div>
{% endcapture %}
{% include 'checkout_page' with checkout_page_content, order: order %}
<script>
    $(function () {
                var checkoutController = new CheckoutController('{{ order.state }}', {{ order.shipping_contact.json_attributes }}, {{ order.shipping_address.json_attributes }});
                $('div.checkout-main').data('checkoutController', checkoutController);
            }
    );
</script>
